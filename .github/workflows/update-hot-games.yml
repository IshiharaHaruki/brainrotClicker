name: Update HOT Games

# è§¦å‘æ¡ä»¶
on:
  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹ UTC (åŒ—äº¬æ—¶é—´ 10 ç‚¹)
  schedule:
    - cron: '0 2 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸æäº¤ä»£ç 

jobs:
  update-hot-games:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œä¾¿äºŽ git æ“ä½œ

      # 2. è®¾ç½® Node.js çŽ¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          npm install
          npm install -g gray-matter glob

      # 4. ä»Ž Cloudflare KV èŽ·å–æ•°æ®å¹¶è®¡ç®— HOT æ¸¸æˆ
      - name: Calculate HOT games from analytics
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_KV_NAMESPACE_ID: ${{ secrets.CLOUDFLARE_KV_NAMESPACE_ID }}
        run: |
          echo "ðŸ“Š æ­£åœ¨ä»Ž Cloudflare KV èŽ·å–æ¸¸æˆç»Ÿè®¡æ•°æ®..."
          node scripts/calculate-hot-games.js

          echo "âœ… HOT æ¸¸æˆè®¡ç®—å®Œæˆ"

          # æ˜¾ç¤ºç»“æžœ
          if [ -f .cache/hot-games.json ]; then
            echo "ðŸ“‹ HOT æ¸¸æˆåˆ—è¡¨:"
            cat .cache/hot-games.json | jq '.hotGames'
          fi

      # 5. æ›´æ–°æ¸¸æˆ frontmatter
      - name: Update game frontmatter
        run: |
          echo "ðŸ”„ æ­£åœ¨æ›´æ–°æ¸¸æˆæ–‡ä»¶çš„ frontmatter..."
          node scripts/update-frontmatter.js

          echo "âœ… frontmatter æ›´æ–°å®Œæˆ"

      # 6. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code pages/ || echo "has_changes=true" >> $GITHUB_OUTPUT

      # 7. æäº¤å˜æ›´
      - name: Commit and push changes
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add pages/
          git add .cache/hot-games.json

          git commit -m "chore: update HOT games based on analytics data [skip ci]

          ðŸ¤– Generated by GitHub Actions
          ðŸ“… $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          "

          git push

      # 8. è¾“å‡ºç»“æžœæ‘˜è¦
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š HOT æ¸¸æˆæ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f .cache/hot-games.json ]; then
            echo "### ðŸ”¥ å½“å‰ HOT æ¸¸æˆ (Top 10)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            cat .cache/hot-games.json | jq -r '.details[] | "- **\(.slug)** (è¯„åˆ†: \(.score))"' >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "ðŸ“ˆ **ç»Ÿè®¡å‘¨æœŸ**: $(cat .cache/hot-games.json | jq -r '.period')" >> $GITHUB_STEP_SUMMARY
            echo "â° **ç”Ÿæˆæ—¶é—´**: $(cat .cache/hot-games.json | jq -r '.generatedAt')" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ® **æ€»æ¸¸æˆæ•°**: $(cat .cache/hot-games.json | jq -r '.total')" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ æœªæ‰¾åˆ° HOT æ¸¸æˆæ•°æ®" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.git-check.outputs.has_changes }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **å·²æäº¤å˜æ›´åˆ°ä»“åº“**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸  **æ— å˜æ›´éœ€è¦æäº¤**" >> $GITHUB_STEP_SUMMARY
          fi
